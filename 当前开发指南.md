# 📋 模块开发任务书 (Module Development Task Book)

**Version**: 1.0  
**Phase**: Coding Phase 1 (Core Modules)  
**Tech Stack**: Spring Boot 3 + Vue 3

---

## 模块一：用户与交易模块 (User & Wallet)

本模块是平台的基石，负责用户身份认证与资金管理。请务必保证资金操作的原子性与安全性。

### 1. 涉及的数据表 (Database)

| 表名 (Table Name) | 实体类名 (Entity) | 说明 |
| :--- | :--- | :--- |
| `users` | `User` | 用户核心信息 (账号、密码、头像) |
| `user_profiles` | `UserProfile` | 用户详细画像 (非核心字段) |
| `user_wallets` | `UserWallet` | **[高危]** 用户钱包余额 |
| `wallet_transactions` | `WalletTransaction` | **[高危]** 交易流水记录 |
| `roles` / `permissions` | `Role` / `Permission` | (可选) RBAC权限控制，初版可简略 |

### 2. 核心接口清单 (API To-Do List)

请参考 `User & Auth` 和 `Wallet Service` 章节。

- [ ] **用户注册 (Register)** `POST /auth/register`
    - [ ] 校验用户名唯一性。
    - [ ] 密码使用 BCrypt 加密存储。
    - [ ] **关键**: 注册成功后，必须同步在 `user_wallets` 表插入一条记录，初始化余额为 0。
- [ ] **用户登录 (Login)** `POST /auth/login`
    - [ ] 校验账号密码。
    - [ ] **集成 Sa-Token**: 登录成功调用 `StpUtil.login(userId)` 生成 Token。
    - [ ] 返回 Token 和 用户基本信息。
- [ ] **获取个人信息 (Profile)** `GET /user/profile`
    - [ ] 需返回 `users` 和 `user_profiles` 的聚合信息。
- [ ] **获取钱包余额 (Balance)** `GET /wallet/balance`
    - [ ] 查询 `user_wallets.balance`。
- [ ] **(Mock) 充值接口** `POST /wallet/recharge`
    - [ ] 暂时模拟充值成功，增加 `user_wallets` 余额，写入 `wallet_transactions` 流水。

### 3. 开发逻辑提示 (Logic Hints)

#### 后端 (Backend)
- **密码安全**: 严禁明文存储密码！使用 `BCryptPasswordEncoder`。
- **事务管理**: 注册接口涉及到 `users` 和 `user_wallets` 两张表的插入，必须加 `@Transactional` 注解，确保要么都成功，要么都失败。
- **Sa-Token**: 认证逻辑全权交给 Sa-Token，不要自己写拦截器。

#### 前端 (Frontend)
- **Store 管理**: 在 `src/stores/user.js` (Pinia) 中定义 `login()` Action。
    - 登录成功后，将 Token 存入 `localStorage` (key: `Authorization`)。
    - 将用户信息存入 Pinia State。
- **路由守卫**: 在 [src/router/index.js](file:///Users/yangli/Documents/%E8%87%AA%E5%8A%A8%E5%8C%96%E7%9F%AD%E8%A7%86%E9%A2%91%E5%88%9B%E4%BD%9C%E5%B9%B3%E5%8F%B0/frontend/src/router/index.js) 中检查，如果未登录访问 `/user/*`，强制跳转 `/login`。

---

## 模块二：创作核心模块 (Creation Core)

本模块是平台的心脏，负责调度 AI 模型生成内容。本次暂不包含“剪辑工程 (Editing Project)”。

### 1. 涉及的数据表 (Database)

| 表名 (Table Name) | 实体类名 (Entity) | 说明 |
| :--- | :--- | :--- |
| `video_generation_tasks` | `VideoTask` | **[核心]** 视频生成任务单 |
| `task_resources` | `TaskResource` | 任务关联的素材 (输入图片/视频) |
| `ai_models` | `AiModel` | AI 模型配置 (用于策略路由) |
| `task_scheduling_configs` | `TaskConfig` | (可选) 调度参数 |

> **注意**: `video_edit_projects` 表及其相关逻辑本次**跳过**。

### 2. 核心接口清单 (API To-Do List)

请参考 `AI Creation Service` 章节。

- [ ] **获取创作灵感 (Inspiration)** `GET /creation/hotspots`
    - [ ] 返回一些预设的热点或脚本模板。
- [ ] **生成分镜头脚本 (Script)** `POST /creation/generate-script`
    - [ ] 调用 LLM (如 GPT/Claude) 生成脚本结构。
- [ ] **AI 通用文本生成 (Text Gen)** `POST /creation/text/generate`
    - [ ] **同步接口**: 直接调用 LLM (GPT/Claude) 返回文本内容，不走任务队列。
- [ ] **提交生成任务 (Submit Task)** `POST /creation/submit`
    - [ ] **支持多种模式**: 兼容 `task_type` 的耗时任务枚举 (2-文生图, 3-文生视频, 4-文加图生视频)。
    - [ ] **异步接口**: 接收参数 -> 校验余额 -> 扣费 -> 写入 `video_generation_tasks` (状态 PENDING) -> 返回 `taskId`。
    - [ ] **不要等待** AI 生成完成，直接返回任务ID。
    - [ ] 触发异步线程或消息队列去调用 AI 模型。
- [ ] **查询任务状态 (Poll Status)** `GET /creation/task/{taskId}`
    - [ ] 前端轮询此接口，获取进度 `progress` 和状态 `status`。

### 3. 开发逻辑提示 (Logic Hints)

#### 后端 (Backend)
- **策略模式 (Strategy Pattern)**:
    - 定义 `ModelStrategy` 接口 (`generate(Task task)`)。
    - 实现 `RunwayStrategy`, `GptStrategy` 等实现类。
    - 根据前端传的 `model_key` 或 `ai_models` 表配置，动态选择策略类执行。
- **状态流转**:
    - 任务状态机：`WAITING` (1) -> `PROCESSING` (2) -> `SUCCESS` (3) / `FAIL` (4)。
    - 生成完成后，务必回写 `result_video_path` 到任务表。
- **异步处理**: 使用 Spring 的 `@Async` 或线程池处理耗时的 AI 请求，避免阻塞主线程。

#### 前端 (Frontend)
- **轮询机制**: 提交任务后，前端进入“生成中”页面，使用 `setInterval` 每 3-5 秒调用一次“查询任务状态”接口。
- **状态映射**:
    - `status=2` -> 显示进度条。
    - `status=3` -> 显示视频播放器。
    - `status=4` -> 显示错误提示和重试按钮。
- **防抖**: 提交按钮点击后需 Disable，防止重复提交扣费。
